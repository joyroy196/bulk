<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bulk ID Card Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/JsBarcode/3.11.5/JsBarcode.all.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #2d3a8c;
    --accent: #c9a84c;
    --band: #b07fa3;
    --cream: #f8f5ee;
    --dark: #1a2260;
    --glass: rgba(255,255,255,0.7);
    --shadow: 0 8px 32px rgba(44,58,140,0.13);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(135deg, #e8e0f0 0%, #d6e4f7 50%, #e0f0e8 100%);
    min-height: 100vh;
    color: #1a2260;
  }

  /* HEADER */
  header {
    background: linear-gradient(90deg, #2d3a8c 0%, #4a3580 100%);
    padding: 18px 40px;
    display: flex;
    align-items: center;
    gap: 18px;
    box-shadow: 0 4px 20px rgba(44,58,140,0.3);
  }
  .logo-icon {
    width: 46px; height: 46px;
    background: linear-gradient(135deg, #c9a84c, #f0d080);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }
  header h1 {
    font-family: 'Playfair Display', serif;
    color: #fff;
    font-size: 1.6rem;
    letter-spacing: 0.5px;
  }
  header p { color: rgba(255,255,255,0.6); font-size: 0.82rem; margin-top: 2px; }
  .header-right {
    margin-left: auto;
    display: flex; gap: 10px;
  }
  .stat-pill {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 50px;
    padding: 6px 16px;
    font-size: 0.82rem;
    display: flex; align-items: center; gap: 6px;
  }
  .stat-num { font-weight: 700; color: #f0d080; font-size: 1rem; }

  /* LAYOUT */
  .main { display: grid; grid-template-columns: 380px 1fr; gap: 0; min-height: calc(100vh - 74px); }

  /* SIDEBAR */
  .sidebar {
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(16px);
    border-right: 1px solid rgba(200,190,220,0.3);
    padding: 28px 24px;
    overflow-y: auto;
    max-height: calc(100vh - 74px);
    position: sticky; top: 0;
  }
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1rem;
    color: var(--primary);
    margin-bottom: 14px;
    display: flex; align-items: center; gap: 8px;
  }
  .section-title::after {
    content: '';
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), transparent);
    border-radius: 2px;
    margin-left: 8px;
  }

  /* FORM */
  .form-group { margin-bottom: 14px; }
  label { font-size: 0.78rem; font-weight: 600; color: #4a4a7a; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
  input[type="text"], input[type="email"], textarea {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid #ddd8ee;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    color: #1a2260;
    background: #fcfaff;
    transition: border 0.2s, box-shadow 0.2s;
    outline: none;
  }
  input[type="text"]:focus, input[type="email"]:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(45,58,140,0.08);
    background: #fff;
  }
  textarea { resize: vertical; min-height: 60px; }

  /* PHOTO UPLOAD */
  .photo-upload {
    border: 2px dashed #c5bde8;
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #faf8ff;
    position: relative;
    overflow: hidden;
  }
  .photo-upload:hover { border-color: var(--primary); background: #f0eeff; }
  .photo-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .photo-preview {
    width: 70px; height: 70px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid var(--accent);
    margin: 0 auto 6px;
    display: none;
  }
  .photo-upload-icon { font-size: 28px; margin-bottom: 4px; }
  .photo-upload p { font-size: 0.78rem; color: #7a7aaa; }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 7px;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 0.88rem;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--primary), #4a3580);
    color: #fff;
    width: 100%;
    justify-content: center;
    padding: 12px;
    font-size: 0.95rem;
    box-shadow: 0 4px 14px rgba(45,58,140,0.3);
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(45,58,140,0.4); }
  .btn-accent {
    background: linear-gradient(135deg, var(--accent), #e8b84b);
    color: #fff;
    box-shadow: 0 4px 14px rgba(201,168,76,0.3);
  }
  .btn-accent:hover { transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    border: 1.5px solid var(--primary);
    color: var(--primary);
  }
  .btn-outline:hover { background: var(--primary); color: #fff; }
  .btn-danger {
    background: transparent;
    border: 1.5px solid #e05555;
    color: #e05555;
    padding: 6px 12px;
    font-size: 0.78rem;
  }
  .btn-danger:hover { background: #e05555; color: #fff; }
  .btn-edit {
    background: transparent;
    border: 1.5px solid var(--accent);
    color: var(--accent);
    padding: 6px 12px;
    font-size: 0.78rem;
  }
  .btn-edit:hover { background: var(--accent); color: #fff; }
  .btn-sm { padding: 6px 14px; font-size: 0.82rem; }

  /* CSV UPLOAD ZONE */
  .csv-zone {
    border: 2px dashed #c5bde8;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    background: linear-gradient(135deg, #faf8ff, #f0f4ff);
    transition: all 0.2s;
    position: relative;
    margin-bottom: 18px;
  }
  .csv-zone:hover { border-color: var(--primary); background: #eeeaff; }
  .csv-zone input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .csv-zone h3 { font-size: 0.9rem; color: var(--primary); margin: 6px 0 3px; }
  .csv-zone p { font-size: 0.75rem; color: #7a7aaa; }

  /* DIVIDER */
  .divider {
    display: flex; align-items: center; gap: 10px;
    margin: 18px 0;
    color: #9999bb;
    font-size: 0.78rem; font-weight: 600;
  }
  .divider::before, .divider::after {
    content: ''; flex: 1;
    height: 1px; background: #e0daf0;
  }

  /* SCHOOL NAME BAR */
  .school-bar {
    background: linear-gradient(135deg, #f0eeff, #e8f0ff);
    border: 1.5px solid #d0c8f0;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 18px;
    display: flex; align-items: center; gap: 10px;
  }
  .school-bar label { margin: 0; white-space: nowrap; }
  .school-bar input { border: none; background: transparent; padding: 4px 8px; font-size: 1rem; font-weight: 700; color: var(--primary); }

  /* ACTIONS ROW */
  .actions-row {
    display: flex; gap: 8px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }

  /* CONTENT AREA */
  .content {
    padding: 28px;
    overflow-y: auto;
  }
  .content-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px;
  }
  .content-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    color: var(--primary);
  }

  /* CARD GRID */
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 28px;
  }

  /* CARD WRAPPER */
  .card-wrapper {
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
    border-radius: 18px;
    padding: 16px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(200,190,220,0.3);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card-wrapper:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(44,58,140,0.18); }
  .card-actions-bar {
    display: flex; gap: 6px; margin-top: 12px; justify-content: flex-end;
  }

  /* ID CARD */
  .id-card {
    width: 100%;
    aspect-ratio: 1.586;
    background: var(--cream);
    border-radius: 12px;
    overflow: hidden;
    font-family: 'DM Sans', sans-serif;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }
  .card-band { height: 14%; background: #b07fa3; }
  .card-band.bottom { margin-top: auto; }
  .card-body {
    display: flex;
    padding: 0 5% 0;
    flex: 1;
    gap: 5%;
    align-items: flex-start;
    padding-top: 3%;
  }
  .card-left { display: flex; flex-direction: column; align-items: center; width: 35%; }
  .card-photo {
    width: 100%;
    aspect-ratio: 0.85;
    object-fit: cover;
    border-radius: 4px;
    background: #d8d8e8;
    border: 1px solid #ccc;
  }
  .card-barcode-wrap { margin-top: 5px; width: 100%; }
  .card-barcode-wrap svg { width: 100%; height: auto; }
  .card-right { flex: 1; padding-top: 2%; }
  .card-school-name {
    font-size: clamp(0.7rem, 2.2vw, 1.1rem);
    font-weight: 800;
    color: var(--dark);
    text-align: center;
    padding: 2% 5%;
  }
  .card-badge {
    background: linear-gradient(135deg, #c9a84c, #e8c96a);
    border-radius: 0 50px 50px 0;
    padding: 5% 10% 5% 6%;
    font-size: clamp(0.6rem, 1.8vw, 0.9rem);
    font-weight: 800;
    color: var(--dark);
    margin-bottom: 6%;
    display: inline-block;
    letter-spacing: 0.3px;
  }
  .card-info-row {
    display: flex;
    align-items: flex-start;
    margin-bottom: 3%;
    font-size: clamp(0.5rem, 1.5vw, 0.75rem);
    line-height: 1.3;
  }
  .card-info-label {
    font-weight: 700;
    color: var(--dark);
    min-width: 35%;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .card-info-sep { color: #aaa; margin: 0 4px; }
  .card-info-val { color: #333; flex: 1; word-break: break-word; }

  /* INNER CARD LAYOUT */
  .id-card-inner {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 80px 40px;
    color: #9999bb;
  }
  .empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
  .empty-state h2 { font-family: 'Playfair Display', serif; color: var(--primary); margin-bottom: 8px; }
  .empty-state p { font-size: 0.9rem; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 28px; right: 28px;
    background: linear-gradient(135deg, var(--primary), #4a3580);
    color: #fff;
    padding: 12px 22px;
    border-radius: 12px;
    font-size: 0.88rem;
    box-shadow: 0 8px 24px rgba(45,58,140,0.4);
    z-index: 9999;
    display: none;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* TABS */
  .tabs { display: flex; gap: 0; margin-bottom: 18px; border-radius: 10px; overflow: hidden; border: 1.5px solid #ddd8ee; }
  .tab {
    flex: 1; padding: 9px; text-align: center;
    font-size: 0.82rem; font-weight: 600;
    cursor: pointer;
    background: #faf8ff;
    color: #7a7aaa;
    border: none;
    transition: all 0.2s;
  }
  .tab.active { background: var(--primary); color: #fff; }

  /* MODAL */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(10,10,40,0.5);
    backdrop-filter: blur(6px);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: #fff;
    border-radius: 20px;
    padding: 32px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    animation: popIn 0.3s ease;
  }
  @keyframes popIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  .modal h2 { font-family: 'Playfair Display', serif; color: var(--primary); margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

  /* PRINT STYLES */
  @media print {
    header, .sidebar, .content-header, .card-actions-bar, .card-wrapper { box-shadow: none !important; }
    .sidebar { display: none; }
    .main { grid-template-columns: 1fr; }
    .cards-grid { grid-template-columns: repeat(2, 1fr); }
    .card-wrapper { background: white; border: 1px solid #eee; }
  }

  /* CSV SAMPLE TABLE */
  .sample-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; margin-top: 8px; }
  .sample-table th { background: var(--primary); color: white; padding: 4px 8px; text-align: left; }
  .sample-table td { padding: 3px 8px; border-bottom: 1px solid #eee; color: #555; }
  .sample-table tr:nth-child(even) td { background: #f8f5ee; }

  .progress-bar {
    width: 100%; height: 6px;
    background: #e8e0f0;
    border-radius: 6px;
    overflow: hidden;
    margin-top: 8px;
    display: none;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border-radius: 6px;
    transition: width 0.3s;
    width: 0%;
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo-icon">ü™™</div>
  <div>
    <h1>Bulk ID Card Generator</h1>
    <p>Create professional student ID cards in seconds</p>
  </div>
  <div class="header-right">
    <div class="stat-pill">Total Cards: <span class="stat-num" id="totalCount">0</span></div>
    <button class="btn btn-accent btn-sm" onclick="downloadAllZip()">‚¨á Download All ZIP</button>
    <button class="btn btn-outline btn-sm" style="color:#fff;border-color:rgba(255,255,255,0.4);" onclick="window.print()">üñ® Print</button>
  </div>
</header>

<div class="main">
  <!-- SIDEBAR -->
  <aside class="sidebar">

    <!-- School Name -->
    <div class="school-bar">
      <label>üè´</label>
      <input type="text" id="schoolName" value="Rimberio High School" placeholder="School Name">
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('manual', this)">‚úè Manual Entry</button>
      <button class="tab" onclick="switchTab('csv', this)">üìÑ CSV Upload</button>
    </div>

    <!-- MANUAL TAB -->
    <div id="tab-manual">
      <p class="section-title">üë§ Student Details</p>

      <div class="form-group">
        <div class="photo-upload" id="photoDropZone">
          <input type="file" id="photoInput" accept="image/*" onchange="handlePhotoChange(event)">
          <img id="photoPreview" class="photo-preview" src="" alt="">
          <div id="photoPlaceholder">
            <div class="photo-upload-icon">üì∑</div>
            <p>Click to upload photo</p>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="inputName" placeholder="e.g. Chiaki Sato">
      </div>
      <div class="form-group">
        <label>Student ID *</label>
        <input type="text" id="inputID" placeholder="e.g. 123-456-7890">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="inputEmail" placeholder="e.g. hello@example.com">
      </div>
      <div class="form-group">
        <label>Address</label>
        <textarea id="inputAddress" placeholder="e.g. 123 Anywhere St., Any City"></textarea>
      </div>

      <button class="btn btn-primary" onclick="addCard()">+ Add ID Card</button>
    </div>

    <!-- CSV TAB -->
    <div id="tab-csv" style="display:none;">
      <div class="csv-zone">
        <input type="file" id="csvInput" accept=".csv" onchange="handleCSV(event)">
        <div style="font-size:36px">üìÑ</div>
        <h3>Upload CSV File</h3>
        <p>Drag & drop or click to browse</p>
      </div>

      <details style="margin-bottom:14px;">
        <summary style="font-size:0.8rem; cursor:pointer; color: var(--primary); font-weight:600;">üìã CSV Format Example</summary>
        <table class="sample-table">
          <thead>
            <tr><th>Name</th><th>ID</th><th>Email</th><th>Address</th></tr>
          </thead>
          <tbody>
            <tr><td>Chiaki Sato</td><td>123-456-7890</td><td>hello@ex.com</td><td>123 Main St</td></tr>
            <tr><td>John Doe</td><td>987-654-3210</td><td>john@ex.com</td><td>456 Park Ave</td></tr>
          </tbody>
        </table>
        <button class="btn btn-outline btn-sm" style="margin-top:10px; width:100%;" onclick="downloadSampleCSV()">‚¨á Download Sample CSV</button>
      </details>

      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div style="height:18px;"></div>
    <div class="actions-row">
      <button class="btn btn-outline btn-sm" onclick="clearAll()" style="flex:1;">üóë Clear All</button>
    </div>
  </aside>

  <!-- CONTENT -->
  <div class="content">
    <div class="content-header">
      <div class="content-title">Generated ID Cards</div>
    </div>

    <div id="emptyState" class="empty-state">
      <div class="empty-icon">ü™™</div>
      <h2>No Cards Yet</h2>
      <p>Add student details manually or upload a CSV file to generate ID cards instantly.</p>
    </div>

    <div class="cards-grid" id="cardsGrid"></div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h2>‚úè Edit Student Card</h2>
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" id="editName">
    </div>
    <div class="form-group">
      <label>Student ID</label>
      <input type="text" id="editID">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="editEmail">
    </div>
    <div class="form-group">
      <label>Address</label>
      <textarea id="editAddress"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" style="width:auto;" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let students = [];
  let editIndex = null;
  let currentPhotoDataURL = null;

  function switchTab(tab, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    document.getElementById('tab-manual').style.display = tab === 'manual' ? '' : 'none';
    document.getElementById('tab-csv').style.display = tab === 'csv' ? '' : 'none';
  }

  function handlePhotoChange(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      currentPhotoDataURL = ev.target.result;
      const preview = document.getElementById('photoPreview');
      preview.src = currentPhotoDataURL;
      preview.style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
    };
    reader.readAsDataURL(file);
  }

  function addCard() {
    const name = document.getElementById('inputName').value.trim();
    const id = document.getElementById('inputID').value.trim();
    const email = document.getElementById('inputEmail').value.trim();
    const address = document.getElementById('inputAddress').value.trim();
    if (!name || !id) { showToast('‚ö† Name and ID are required!'); return; }
    students.push({ name, id, email, address, photo: currentPhotoDataURL });
    renderCards();
    clearForm();
    showToast('‚úÖ Card added successfully!');
  }

  function clearForm() {
    document.getElementById('inputName').value = '';
    document.getElementById('inputID').value = '';
    document.getElementById('inputEmail').value = '';
    document.getElementById('inputAddress').value = '';
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('photoPlaceholder').style.display = '';
    document.getElementById('photoInput').value = '';
    currentPhotoDataURL = null;
  }

  function handleCSV(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const lines = ev.target.result.split('\n').filter(l => l.trim());
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/[^a-z]/g,''));
      const bar = document.getElementById('progressBar');
      const fill = document.getElementById('progressFill');
      bar.style.display = 'block';
      let added = 0;
      const total = lines.length - 1;
      for (let i = 1; i < lines.length; i++) {
        const cols = parseCSVLine(lines[i]);
        if (cols.length < 2) continue;
        const obj = {};
        headers.forEach((h, idx) => { obj[h] = (cols[idx] || '').trim(); });
        students.push({
          name: obj.name || obj['fullname'] || '',
          id: obj.id || obj['studentid'] || obj['studentno'] || '',
          email: obj.email || '',
          address: obj.address || '',
          photo: null
        });
        added++;
        fill.style.width = ((i / total) * 100) + '%';
      }
      setTimeout(() => { bar.style.display = 'none'; fill.style.width = '0%'; }, 800);
      renderCards();
      showToast(`‚úÖ ${added} cards imported from CSV!`);
    };
    reader.readAsText(file);
  }

  function parseCSVLine(line) {
    const result = [];
    let cur = '', inQ = false;
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c === '"') { inQ = !inQ; continue; }
      if (c === ',' && !inQ) { result.push(cur); cur = ''; continue; }
      cur += c;
    }
    result.push(cur);
    return result;
  }

  function renderCards() {
    const grid = document.getElementById('cardsGrid');
    const empty = document.getElementById('emptyState');
    document.getElementById('totalCount').textContent = students.length;
    if (students.length === 0) {
      empty.style.display = '';
      grid.innerHTML = '';
      return;
    }
    empty.style.display = 'none';
    grid.innerHTML = '';
    students.forEach((s, i) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'card-wrapper';
      wrapper.innerHTML = `
        <div class="id-card" id="card-${i}">
          <div class="id-card-inner">
            <div class="card-band"></div>
            <div style="text-align:center;">
              <div class="card-school-name">${escHtml(document.getElementById('schoolName').value || 'School Name')}</div>
            </div>
            <div class="card-body">
              <div class="card-left">
                ${s.photo ? `<img class="card-photo" src="${s.photo}" alt="Photo">` : `<div class="card-photo" style="display:flex;align-items:center;justify-content:center;font-size:36px;">üë§</div>`}
                <div class="card-barcode-wrap">
                  <svg class="barcode-svg-${i}"></svg>
                </div>
              </div>
              <div class="card-right">
                <div class="card-badge">Student ID Card</div>
                <div class="card-info-row">
                  <span class="card-info-label">Name</span>
                  <span class="card-info-sep">:</span>
                  <span class="card-info-val">${escHtml(s.name)}</span>
                </div>
                <div class="card-info-row">
                  <span class="card-info-label">ID</span>
                  <span class="card-info-sep">:</span>
                  <span class="card-info-val">${escHtml(s.id)}</span>
                </div>
                ${s.email ? `<div class="card-info-row">
                  <span class="card-info-label">Email</span>
                  <span class="card-info-sep">:</span>
                  <span class="card-info-val">${escHtml(s.email)}</span>
                </div>` : ''}
                ${s.address ? `<div class="card-info-row">
                  <span class="card-info-label">Address</span>
                  <span class="card-info-sep">:</span>
                  <span class="card-info-val">${escHtml(s.address)}</span>
                </div>` : ''}
              </div>
            </div>
            <div class="card-band bottom"></div>
          </div>
        </div>
        <div class="card-actions-bar">
          <button class="btn btn-edit" onclick="openEdit(${i})">‚úè Edit</button>
          <button class="btn btn-accent btn-sm" onclick="downloadCard(${i})">‚¨á PNG</button>
          <button class="btn btn-danger" onclick="deleteCard(${i})">üóë Delete</button>
        </div>
      `;
      grid.appendChild(wrapper);
      // Render barcode
      try {
        JsBarcode(`.barcode-svg-${i}`, s.id.replace(/[^0-9A-Za-z\-\.\ \$\/\+\%]/g, ''), {
          format: "CODE128",
          width: 1.2,
          height: 28,
          displayValue: false,
          margin: 2
        });
      } catch(err) { /* skip invalid barcode */ }
    });
  }

  function escHtml(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function deleteCard(i) {
    students.splice(i, 1);
    renderCards();
    showToast('üóë Card deleted');
  }

  function openEdit(i) {
    editIndex = i;
    const s = students[i];
    document.getElementById('editName').value = s.name;
    document.getElementById('editID').value = s.id;
    document.getElementById('editEmail').value = s.email;
    document.getElementById('editAddress').value = s.address;
    document.getElementById('editModal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('editModal').classList.remove('show');
    editIndex = null;
  }

  function saveEdit() {
    if (editIndex === null) return;
    students[editIndex].name = document.getElementById('editName').value.trim();
    students[editIndex].id = document.getElementById('editID').value.trim();
    students[editIndex].email = document.getElementById('editEmail').value.trim();
    students[editIndex].address = document.getElementById('editAddress').value.trim();
    renderCards();
    closeModal();
    showToast('‚úÖ Card updated!');
  }

  async function downloadCard(i) {
    const el = document.getElementById(`card-${i}`);
    showToast('‚è≥ Generating PNG...');
    const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
    const link = document.createElement('a');
    link.download = `id-card-${students[i].name.replace(/\s+/g,'-')}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast('‚úÖ Downloaded!');
  }

  async function downloadAllZip() {
    if (students.length === 0) { showToast('‚ö† No cards to download!'); return; }
    showToast('‚è≥ Preparing ZIP...');
    const zip = new JSZip();
    const folder = zip.folder('ID-Cards');
    for (let i = 0; i < students.length; i++) {
      const el = document.getElementById(`card-${i}`);
      if (!el) continue;
      const canvas = await html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null });
      const dataURL = canvas.toDataURL('image/png');
      const base64 = dataURL.split(',')[1];
      folder.file(`id-card-${students[i].name.replace(/\s+/g,'-') || i}.png`, base64, { base64: true });
    }
    const blob = await zip.generateAsync({ type: 'blob' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'ID-Cards-Bulk.zip';
    link.click();
    showToast('‚úÖ ZIP Downloaded!');
  }

  function clearAll() {
    if (students.length === 0) return;
    if (!confirm('Clear all cards?')) return;
    students = [];
    renderCards();
    showToast('üóë All cards cleared');
  }

  function downloadSampleCSV() {
    const content = `Name,ID,Email,Address\nChiaki Sato,123-456-7890,hello@example.com,"123 Anywhere St., Any City"\nJohn Doe,987-654-3210,john@example.com,"456 Park Ave, New York"`;
    const blob = new Blob([content], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'sample-students.csv';
    link.click();
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(t._timeout);
    t._timeout = setTimeout(() => { t.style.display = 'none'; }, 2500);
  }

  // School name live update
  document.getElementById('schoolName').addEventListener('input', () => {
    if (students.length > 0) renderCards();
  });

  // Close modal on overlay click
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // Load sample data
  window.addEventListener('load', () => {
    students = [
      { name: 'Chiaki Sato', id: '123-456-7890', email: 'hello@reallygreatsite.com', address: '123 Anywhere St., Any City', photo: null }
    ];
    renderCards();
  });
</script>
</body>
</html>
