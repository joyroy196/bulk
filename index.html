<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bulk ID Card Generator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #21262d;
    --border: #30363d;
    --accent: #2563eb;
    --accent2: #10b981;
    --text: #e6edf3;
    --text2: #8b949e;
    --danger: #f85149;
    --sidebar-w: 380px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* HEADER */
  .app-header {
    background: linear-gradient(135deg, #0d1117 0%, #161b22 50%, #0d1117 100%);
    border-bottom: 1px solid var(--border);
    padding: 14px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }
  .app-header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--accent2), transparent);
  }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .app-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }
  .app-header span {
    font-size: 12px;
    color: var(--text2);
    margin-left: auto;
  }

  /* LAYOUT */
  .app-body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .sidebar-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .sidebar-scroll::-webkit-scrollbar { width: 4px; }
  .sidebar-scroll::-webkit-scrollbar-track { background: transparent; }
  .sidebar-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .section {
    border-bottom: 1px solid var(--border);
    padding-bottom: 14px;
    margin-bottom: 14px;
  }
  .section:last-child { border-bottom: none; }
  .section-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--text2);
    margin-bottom: 10px;
  }

  label { font-size: 12px; color: var(--text2); display: block; margin-bottom: 4px; margin-top: 8px; }
  label:first-child { margin-top: 0; }
  input[type="text"], input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 7px 10px;
    outline: none;
    transition: border-color 0.15s;
  }
  input[type="text"]:focus, input[type="number"]:focus { border-color: var(--accent); }

  /* ALIGN TOGGLE */
  .align-group { display: flex; gap: 4px; }
  .align-btn {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px;
    cursor: pointer;
    color: var(--text2);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .align-btn:hover { border-color: var(--accent); color: var(--text); }
  .align-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .align-btn svg { width: 14px; height: 14px; display: block; }

  /* COLOR CONTROL */
  .color-row { display: flex; gap: 6px; align-items: center; }
  .color-row input[type="color"] {
    width: 36px; height: 32px;
    padding: 2px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--surface2);
    cursor: pointer;
    flex-shrink: 0;
  }
  .color-row input[type="text"] { flex: 1; font-family: monospace; font-size: 12px; }

  /* SLIDER */
  .slider-row { display: flex; gap: 8px; align-items: center; }
  input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }
  .slider-val {
    font-size: 12px;
    color: var(--text2);
    min-width: 30px;
    text-align: right;
  }

  /* DROP ZONES */
  .dropzone {
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .dropzone:hover, .dropzone.drag-over {
    border-color: var(--accent);
    background: rgba(37, 99, 235, 0.06);
  }
  .dropzone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer;
  }
  .dropzone-icon { font-size: 22px; margin-bottom: 4px; }
  .dropzone-text { font-size: 12px; color: var(--text2); }
  .dropzone-text strong { color: var(--text); }
  .dropzone-status {
    font-size: 11px;
    color: var(--accent2);
    margin-top: 4px;
    font-weight: 500;
  }

  /* SIDEBAR ACTIONS */
  .sidebar-actions {
    padding: 12px 16px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-shrink: 0;
  }
  .btn {
    width: 100%;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #3b82f6);
    color: #fff;
  }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent2); color: var(--accent2); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* MAIN AREA */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* TABS */
  .tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    flex-shrink: 0;
  }
  .tab {
    padding: 12px 20px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    display: flex; align-items: center; gap: 6px;
    position: relative;
    top: 1px;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--text); border-bottom-color: var(--accent); }
  .badge {
    background: var(--accent2);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    line-height: 16px;
  }

  /* TAB PANELS */
  .tab-panel { display: none; flex: 1; overflow: hidden; }
  .tab-panel.active { display: flex; flex-direction: column; }

  /* PREVIEW PANEL */
  .preview-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow-y: auto;
    padding: 24px;
    gap: 16px;
    background: var(--bg);
  }
  .preview-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--text2);
    text-align: center;
    gap: 12px;
  }
  .preview-empty-icon { font-size: 48px; opacity: 0.4; }
  .preview-empty h3 { font-size: 16px; color: var(--text); }
  .preview-empty p { font-size: 13px; max-width: 280px; line-height: 1.5; }
  #liveCanvas {
    max-width: 760px;
    width: 100%;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: none;
  }
  .preview-nav {
    display: flex; align-items: center; gap: 12px;
    display: none;
  }
  .nav-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    padding: 6px 14px;
    cursor: pointer;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .nav-btn:hover { border-color: var(--accent); }
  .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .nav-info { font-size: 13px; color: var(--text2); min-width: 80px; text-align: center; }

  /* GENERATED PANEL */
  .generated-panel {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: var(--bg);
  }
  .generated-panel::-webkit-scrollbar { width: 6px; }
  .generated-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .progress-wrap {
    margin-bottom: 16px;
    display: none;
  }
  .progress-bar-bg {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 3px;
    transition: width 0.1s;
    width: 0;
  }
  .progress-text { font-size: 12px; color: var(--text2); margin-top: 4px; }
  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
  }
  .card-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
  }
  .card-item img { width: 100%; display: block; }
  .card-item-footer {
    padding: 8px 10px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-item-name { font-size: 12px; color: var(--text2); font-weight: 500; }
  .dl-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-size: 11px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.12s;
    text-decoration: none;
    display: inline-block;
  }
  .dl-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .generated-empty {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 200px; color: var(--text2); gap: 8px;
  }
</style>
</head>
<body>

<div class="app-header">
  <div class="logo-icon">ğŸªª</div>
  <h1>Bulk ID Card Generator</h1>
  <span>Canvas Â· SheetJS Â· JSZip</span>
</div>

<div class="app-body">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-scroll">

      <!-- Institution -->
      <div class="section">
        <div class="section-title">Institution Info</div>
        <label>Institution Name</label>
        <input type="text" id="instName" value="Your School Name Here" oninput="debouncedRender()">
        <label>Subtitle</label>
        <input type="text" id="instSub" value="An English Medium School" oninput="debouncedRender()">
        <label>Card Title</label>
        <input type="text" id="cardTitle" value="Student Identity Card" oninput="debouncedRender()">
        <label>Title Alignment</label>
        <div class="align-group" id="titleAlignGroup">
          <button class="align-btn active" data-align="left" onclick="setAlign('titleAlign','left',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="0" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
          <button class="align-btn" data-align="center" onclick="setAlign('titleAlign','center',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="2" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
          <button class="align-btn" data-align="right" onclick="setAlign('titleAlign','right',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="4" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
        </div>
        <label>Info Fields Alignment</label>
        <div class="align-group" id="infoAlignGroup">
          <button class="align-btn active" data-align="left" onclick="setAlign('infoAlign','left',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="0" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
          <button class="align-btn" data-align="center" onclick="setAlign('infoAlign','center',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="2" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
          <button class="align-btn" data-align="right" onclick="setAlign('infoAlign','right',this)">
            <svg viewBox="0 0 14 14" fill="currentColor"><rect x="0" y="1" width="14" height="2"/><rect x="4" y="5" width="10" height="2"/><rect x="0" y="9" width="14" height="2"/></svg>
          </button>
        </div>
      </div>

      <!-- Colors -->
      <div class="section">
        <div class="section-title">Typography &amp; Colors</div>
        <label>Label Color</label>
        <div class="color-row">
          <input type="color" id="labelColorPicker" value="#1e3a5f" oninput="syncColor('labelColor',this.value)">
          <input type="text" id="labelColorHex" value="#1e3a5f" oninput="syncColorFromHex('labelColor',this.value)">
        </div>
        <label>Value Color</label>
        <div class="color-row">
          <input type="color" id="valueColorPicker" value="#374151" oninput="syncColor('valueColor',this.value)">
          <input type="text" id="valueColorHex" value="#374151" oninput="syncColorFromHex('valueColor',this.value)">
        </div>
        <label>Font Size</label>
        <div class="slider-row">
          <input type="range" id="fontSize" min="14" max="26" value="17" oninput="state.fontSize=+this.value; document.getElementById('fontSizeVal').textContent=this.value+'px'; debouncedRender()">
          <span class="slider-val" id="fontSizeVal">17px</span>
        </div>
      </div>

      <!-- Header Colors -->
      <div class="section">
        <div class="section-title">Header &amp; Card Style</div>
        <label>Header Left Color</label>
        <div class="color-row">
          <input type="color" id="hdrLeftPicker" value="#1a237e" oninput="syncColor('hdrLeft',this.value)">
          <input type="text" id="hdrLeftHex" value="#1a237e" oninput="syncColorFromHex('hdrLeft',this.value)">
        </div>
        <label>Header Right Color</label>
        <div class="color-row">
          <input type="color" id="hdrRightPicker" value="#283593" oninput="syncColor('hdrRight',this.value)">
          <input type="text" id="hdrRightHex" value="#283593" oninput="syncColorFromHex('hdrRight',this.value)">
        </div>
        <label>Accent Strip Color</label>
        <div class="color-row">
          <input type="color" id="accentColorPicker" value="#e53935" oninput="syncColor('accentColor',this.value)">
          <input type="text" id="accentColorHex" value="#e53935" oninput="syncColorFromHex('accentColor',this.value)">
        </div>
        <label>Card Background Color</label>
        <div class="color-row">
          <input type="color" id="cardBgPicker" value="#ffffff" oninput="syncColor('cardBg',this.value)">
          <input type="text" id="cardBgHex" value="#ffffff" oninput="syncColorFromHex('cardBg',this.value)">
        </div>
      </div>

      <!-- Data Upload -->
      <div class="section">
        <div class="section-title">Student Data</div>
        <div class="dropzone" id="excelDrop">
          <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcel(this)">
          <div class="dropzone-icon">ğŸ“Š</div>
          <div class="dropzone-text"><strong>Drop Excel/CSV here</strong><br>.xlsx Â· .xls Â· .csv</div>
          <div class="dropzone-status" id="excelStatus"></div>
        </div>
      </div>

      <!-- Photo Upload -->
      <div class="section">
        <div class="section-title">Student Photos</div>
        <div class="dropzone" id="photoDrop">
          <input type="file" id="photoFiles" accept="image/*" multiple onchange="handlePhotos(this)">
          <div class="dropzone-icon">ğŸ–¼ï¸</div>
          <div class="dropzone-text"><strong>Drop student photos</strong><br>Matched by filename</div>
          <div class="dropzone-status" id="photoStatus"></div>
        </div>
      </div>

      <!-- Template Upload -->
      <div class="section">
        <div class="section-title">Custom Template (Optional)</div>
        <div class="dropzone" id="templateDrop">
          <input type="file" id="templateFile" accept="image/*" onchange="handleTemplate(this)">
          <div class="dropzone-icon">ğŸ¨</div>
          <div class="dropzone-text"><strong>Drop template image</strong><br>Overrides built-in design</div>
          <div class="dropzone-status" id="templateStatus"></div>
        </div>
      </div>

    </div><!-- /sidebar-scroll -->

    <div class="sidebar-actions">
      <button class="btn btn-primary" onclick="generateAll()">âš¡ Generate All Cards</button>
      <button class="btn btn-secondary" id="downloadZipBtn" onclick="downloadZIP()" disabled>ğŸ“¦ Download ZIP</button>
    </div>
  </div><!-- /sidebar -->

  <!-- MAIN -->
  <div class="main">
    <div class="tab-bar">
      <div class="tab active" id="tabPreview" onclick="switchTab('preview')">ğŸ–¼ Live Preview</div>
      <div class="tab" id="tabGenerated" onclick="switchTab('generated')">ğŸ“‹ Generated Cards <span class="badge" id="cardBadge" style="display:none">0</span></div>
    </div>

    <!-- PREVIEW TAB -->
    <div class="tab-panel active" id="panelPreview">
      <div class="preview-panel" id="previewPanel">
        <div class="preview-empty" id="previewEmpty">
          <div class="preview-empty-icon">ğŸªª</div>
          <h3>No data loaded yet</h3>
          <p>Upload an Excel/CSV file to preview ID cards. Controls update the preview in real time.</p>
        </div>
        <canvas id="liveCanvas" width="856" height="540"></canvas>
        <div class="preview-nav" id="previewNav">
          <button class="nav-btn" id="prevBtn" onclick="navigate(-1)" disabled>â† Prev</button>
          <div class="nav-info" id="navInfo">1 / 1</div>
          <button class="nav-btn" id="nextBtn" onclick="navigate(1)">Next â†’</button>
        </div>
      </div>
    </div>

    <!-- GENERATED TAB -->
    <div class="tab-panel" id="panelGenerated">
      <div class="generated-panel">
        <div class="progress-wrap" id="progressWrap">
          <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill"></div></div>
          <div class="progress-text" id="progressText">Generating...</div>
        </div>
        <div class="cards-grid" id="cardsGrid">
          <div class="generated-empty">No cards generated yet. Click "Generate All Cards" to start.</div>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div>

<!-- HIDDEN CANVAS for generation -->
<canvas id="genCanvas" width="856" height="540" style="display:none"></canvas>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  students: [],
  photos: {},      // filename -> HTMLImageElement
  templateImg: null,
  canvases: [],    // generated dataURLs
  previewIdx: 0,
  instName: 'Your School Name Here',
  instSub: 'An English Medium School',
  cardTitle: 'Student Identity Card',
  titleAlign: 'left',
  infoAlign: 'left',
  labelColor: '#1e3a5f',
  valueColor: '#374151',
  fontSize: 17,
  hdrLeft: '#1a237e',
  hdrRight: '#283593',
  accentColor: '#e53935',
  cardBg: '#ffffff',
};

// â”€â”€â”€ COLOR HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hexToRgb(hex) {
  hex = hex.replace('#','');
  if (hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
  return { r: parseInt(hex.slice(0,2),16), g: parseInt(hex.slice(2,4),16), b: parseInt(hex.slice(4,6),16) };
}
function blendColor(hex1, hex2, t) {
  const a = hexToRgb(hex1), b = hexToRgb(hex2);
  const r = Math.round(a.r+(b.r-a.r)*t);
  const g = Math.round(a.g+(b.g-a.g)*t);
  const bl = Math.round(a.b+(b.b-a.b)*t);
  return `rgb(${r},${g},${bl})`;
}
function darken(hex, amt=0.2) {
  const {r,g,b} = hexToRgb(hex);
  return `rgb(${Math.round(r*(1-amt))},${Math.round(g*(1-amt))},${Math.round(b*(1-amt))})`;
}
function lighten(hex, amt=0.3) {
  const {r,g,b} = hexToRgb(hex);
  return `rgb(${Math.min(255,Math.round(r+(255-r)*amt))},${Math.min(255,Math.round(g+(255-g)*amt))},${Math.min(255,Math.round(b+(255-b)*amt))})`;
}

// â”€â”€â”€ SYNC CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function syncColor(key, val) {
  state[key] = val;
  const hexEl = document.getElementById(key+'Hex') || document.getElementById(key.replace('Color','')+'ColorHex');
  if (hexEl) hexEl.value = val;
  // also sync picker
  const pickerEl = document.getElementById(key+'Picker') || document.getElementById(key.replace('Color','')+'ColorPicker');
  if (pickerEl) pickerEl.value = val;
  debouncedRender();
}
function syncColorFromHex(key, val) {
  if (/^#[0-9a-fA-F]{6}$/.test(val)) {
    state[key] = val;
    const pickerEl = document.getElementById(key+'Picker') || document.getElementById(key.replace('Color','')+'ColorPicker');
    if (pickerEl) pickerEl.value = val;
    debouncedRender();
  }
}
// map color picker ids to state keys
document.querySelectorAll('input[type="color"]').forEach(el => {
  el.addEventListener('input', () => {
    const id = el.id; // e.g. "labelColorPicker"
    const key = id.replace('Picker','');
    state[key] = el.value;
    const hexEl = document.getElementById(id.replace('Picker','Hex'));
    if (hexEl) hexEl.value = el.value;
    debouncedRender();
  });
});
document.querySelectorAll('input[type="text"][id$="Hex"]').forEach(el => {
  el.addEventListener('input', () => {
    const key = el.id.replace('Hex','');
    if (/^#[0-9a-fA-F]{6}$/.test(el.value)) {
      state[key] = el.value;
      const picker = document.getElementById(key+'Picker');
      if (picker) picker.value = el.value;
      debouncedRender();
    }
  });
});
document.querySelectorAll('#instName,#instSub,#cardTitle').forEach(el => {
  el.addEventListener('input', () => {
    const map = {instName:'instName', instSub:'instSub', cardTitle:'cardTitle'};
    state[map[el.id]] = el.value;
  });
});

function setAlign(key, val, btn) {
  state[key] = val;
  const grp = btn.closest('.align-group');
  grp.querySelectorAll('.align-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  debouncedRender();
}

// â”€â”€â”€ DEBOUNCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let debTimer;
function debouncedRender() {
  // sync text inputs
  state.instName = document.getElementById('instName').value;
  state.instSub = document.getElementById('instSub').value;
  state.cardTitle = document.getElementById('cardTitle').value;
  clearTimeout(debTimer);
  debTimer = setTimeout(renderPreview, 50);
}

// â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab,.tab-panel').forEach(el => el.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('panel' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// â”€â”€â”€ DROPZONE DRAG EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.dropzone').forEach(dz => {
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag-over');
    const input = dz.querySelector('input[type="file"]');
    if (input && e.dataTransfer.files.length) {
      input.files = e.dataTransfer.files;
      input.dispatchEvent(new Event('change'));
    }
  });
});

// â”€â”€â”€ FILE HANDLERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleExcel(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const raw = XLSX.utils.sheet_to_json(ws, {defval:''});
      // normalize keys
      state.students = raw.map(row => {
        const n = {};
        Object.keys(row).forEach(k => n[k.toLowerCase().trim()] = String(row[k]).trim());
        return n;
      });
      state.previewIdx = 0;
      document.getElementById('excelStatus').textContent = `âœ“ ${state.students.length} records loaded`;
      updatePreviewVisibility();
      debouncedRender();
    } catch(err) {
      document.getElementById('excelStatus').textContent = 'âš  Error reading file';
    }
  };
  reader.readAsArrayBuffer(file);
}

function handlePhotos(input) {
  const files = Array.from(input.files); if (!files.length) return;
  let loaded = 0;
  state.photos = {};
  files.forEach(f => {
    const key = f.name.toLowerCase();
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        state.photos[key] = img;
        loaded++;
        if (loaded === files.length) {
          document.getElementById('photoStatus').textContent = `âœ“ ${loaded} photos loaded`;
          debouncedRender();
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(f);
  });
  document.getElementById('photoStatus').textContent = `Loading ${files.length} photos...`;
}

function handleTemplate(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => { state.templateImg = img; document.getElementById('templateStatus').textContent = 'âœ“ Template loaded'; debouncedRender(); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
}

// â”€â”€â”€ PREVIEW VISIBILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePreviewVisibility() {
  const hasData = state.students.length > 0;
  document.getElementById('previewEmpty').style.display = hasData ? 'none' : 'flex';
  document.getElementById('liveCanvas').style.display = hasData ? 'block' : 'none';
  document.getElementById('previewNav').style.display = hasData ? 'flex' : 'none';
}

// â”€â”€â”€ NAVIGATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(dir) {
  state.previewIdx = Math.max(0, Math.min(state.students.length-1, state.previewIdx+dir));
  renderPreview();
}
function updateNavUI() {
  const n = state.students.length;
  document.getElementById('navInfo').textContent = n ? `${state.previewIdx+1} / ${n}` : '0 / 0';
  document.getElementById('prevBtn').disabled = state.previewIdx <= 0;
  document.getElementById('nextBtn').disabled = state.previewIdx >= n-1;
}

// â”€â”€â”€ GET STUDENT FIELDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getField(student, ...keys) {
  for (const k of keys) {
    const v = student[k]; if (v && v !== '0') return v;
  }
  return '';
}
function getStudentData(student) {
  return {
    name: getField(student, 'name','student name','full name','student'),
    id: getField(student, 'id','student id','roll no','roll','roll number','enrollment','reg no','registration'),
    cls: getField(student, 'class','department','grade','section','stream'),
    dob: getField(student, 'dob','date of birth','birthdate','birth date','d.o.b'),
    phone: getField(student, 'phone','mobile','contact','tel','telephone','mob'),
    address: getField(student, 'address','addr','location'),
    photoKey: getField(student, 'photo','image','filename','photo filename','img'),
  };
}

// â”€â”€â”€ PHOTO LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPhoto(photoKey) {
  if (!photoKey) return null;
  const k = photoKey.toLowerCase();
  return state.photos[k] || state.photos[k+'.jpg'] || state.photos[k+'.jpeg'] || state.photos[k+'.png'] || null;
}

// â”€â”€â”€ DRAW ID CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCard(canvas, student) {
  const ctx = canvas.getContext('2d');
  const W = 856, H = 540;
  ctx.clearRect(0, 0, W, H);

  // If custom template
  if (state.templateImg) {
    ctx.drawImage(state.templateImg, 0, 0, W, H);
    if (student) drawInfoOnTemplate(ctx, student, W, H);
    return;
  }

  // â”€â”€ Card background â”€â”€
  ctx.fillStyle = state.cardBg;
  ctx.beginPath();
  ctx.roundRect(0, 0, W, H, 12);
  ctx.fill();

  const HDR_H = Math.round(H * 0.43); // 232px

  // â”€â”€ Header gradient â”€â”€
  const grd = ctx.createLinearGradient(0, 0, W, HDR_H);
  grd.addColorStop(0, state.hdrLeft);
  grd.addColorStop(0.6, blendColor(state.hdrLeft, state.hdrRight, 0.6));
  grd.addColorStop(1, state.hdrRight);
  ctx.fillStyle = grd;
  ctx.beginPath();
  ctx.roundRect(0, 0, W, HDR_H, [12, 12, 0, 0]);
  ctx.fill();

  // â”€â”€ Geometric triangle overlays â”€â”€
  function drawTri(x1,y1,x2,y2,x3,y3,alpha) {
    ctx.beginPath();
    ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.lineTo(x3,y3);
    ctx.closePath();
    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.fill();
  }
  drawTri(W*0.4, 0, W*0.7, 0, W*0.55, HDR_H, 0.04);
  drawTri(W*0.6, 0, W, 0, W, HDR_H*0.6, 0.05);
  drawTri(0, 0, W*0.25, 0, 0, HDR_H, 0.04);
  drawTri(W*0.75, 0, W, 0, W, HDR_H*0.3, 0.03);

  // â”€â”€ Bottom-left accent strip (diagonal) â”€â”€
  const stripColor = state.accentColor;
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(0, HDR_H+10);
  ctx.lineTo(0, H);
  ctx.lineTo(W*0.28, H);
  ctx.lineTo(W*0.34, HDR_H+10);
  ctx.closePath();
  ctx.fillStyle = stripColor;
  ctx.fill();
  // darker stripe
  ctx.beginPath();
  ctx.moveTo(0, HDR_H+10);
  ctx.lineTo(0, HDR_H+36);
  ctx.lineTo(W*0.34, HDR_H+36);
  ctx.lineTo(W*0.34, HDR_H+10);
  ctx.closePath();
  ctx.fillStyle = darken(stripColor, 0.25);
  ctx.fill();
  ctx.restore();

  // â”€â”€ Right accent strip â”€â”€
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(W*0.66, HDR_H+10);
  ctx.lineTo(W*0.72, HDR_H+10);
  ctx.lineTo(W, HDR_H+10);
  ctx.lineTo(W, H);
  ctx.lineTo(W*0.72, H);
  ctx.closePath();
  ctx.fillStyle = stripColor;
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(W*0.66, HDR_H+10);
  ctx.lineTo(W, HDR_H+10);
  ctx.lineTo(W, HDR_H+36);
  ctx.lineTo(W*0.66, HDR_H+36);
  ctx.closePath();
  ctx.fillStyle = darken(stripColor, 0.25);
  ctx.fill();
  ctx.restore();

  // â”€â”€ "IDENTITY CARD" labels on strips â”€â”€
  ctx.save();
  ctx.font = 'bold 11px "DM Sans", sans-serif';
  ctx.letterSpacing = '1.5px';
  ctx.fillStyle = '#ffffff';
  ctx.fillText('IDENTITY CARD', 10, HDR_H+27);
  ctx.textAlign = 'right';
  ctx.fillText('IDENTITY CARD', W-10, HDR_H+27);
  ctx.restore();

  // â”€â”€ Logo block (top-right) â”€â”€
  const logoR = 28;
  const logoX = W - logoR - 16;
  const logoY = 14 + logoR;
  // white circle
  ctx.beginPath();
  ctx.arc(logoX, logoY, logoR, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,0.2)';
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 2;
  ctx.stroke();
  // mortarboard emoji
  ctx.font = '22px serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('ğŸ“', logoX, logoY);
  // institution name
  ctx.textAlign = 'right';
  ctx.textBaseline = 'top';
  ctx.fillStyle = '#ffffff';
  const instNameText = state.instName || 'Institution Name';
  const instSubText = state.instSub || '';
  // measure to right-align block
  ctx.font = 'bold 15px "DM Sans", sans-serif';
  ctx.fillText(instNameText, logoX - logoR - 8, 14);
  ctx.font = '11px "DM Sans", sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.75)';
  ctx.fillText(instSubText, logoX - logoR - 8, 33);

  // â”€â”€ Card Title â”€â”€
  const titleArea = { x: W*0.38, w: W*0.55, cx: W*0.38 + (W*0.55)/2 };
  const titleText = state.cardTitle || 'Student Identity Card';
  ctx.font = 'bold 20px "Playfair Display", serif';
  ctx.fillStyle = '#ffffff';
  ctx.textBaseline = 'bottom';
  let titleX;
  if (state.titleAlign === 'center') { ctx.textAlign = 'center'; titleX = titleArea.cx; }
  else if (state.titleAlign === 'right') { ctx.textAlign = 'right'; titleX = titleArea.x + titleArea.w - 10; }
  else { ctx.textAlign = 'left'; titleX = titleArea.x + 10; }
  ctx.fillText(titleText, titleX, HDR_H - 10);

  // â”€â”€ Photo area (left side) â”€â”€
  const photoData = student ? getStudentData(student) : null;
  const photoImg = photoData ? getPhoto(photoData.photoKey) : null;
  const photoR = 72;
  const photoX = W*0.16;
  const photoY = HDR_H * 0.5;
  // white ring
  ctx.beginPath();
  ctx.arc(photoX, photoY, photoR+4, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.fill();
  // clip photo
  ctx.save();
  ctx.beginPath();
  ctx.arc(photoX, photoY, photoR, 0, Math.PI*2);
  ctx.clip();
  if (photoImg) {
    const s = Math.min(photoImg.width, photoImg.height);
    const sx = (photoImg.width-s)/2, sy = (photoImg.height-s)/2;
    ctx.drawImage(photoImg, sx, sy, s, s, photoX-photoR, photoY-photoR, photoR*2, photoR*2);
  } else {
    ctx.fillStyle = '#e0e7ef';
    ctx.fillRect(photoX-photoR, photoY-photoR, photoR*2, photoR*2);
    ctx.font = '56px serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('ğŸ‘¤', photoX, photoY);
  }
  ctx.restore();

  // â”€â”€ Barcode (decorative, seeded) â”€â”€
  const bcY = HDR_H + 50;
  const bcX = photoX - 62;
  const bcW = 124;
  const bcH = 38;
  const seed = photoData ? (photoData.id || photoData.name || 'seed') : 'seed';
  ctx.save();
  ctx.fillStyle = '#222';
  let bx = bcX;
  let seedVal = [...seed].reduce((a,c)=>a+c.charCodeAt(0),0);
  const bars = 42;
  for (let i=0; i<bars; i++) {
    seedVal = (seedVal * 1664525 + 1013904223) & 0xffffffff;
    const bw = (Math.abs(seedVal)%3)+1;
    if (i%2===0) { ctx.fillRect(bx, bcY, bw, bcH); }
    bx += bw + 1;
    if (bx > bcX+bcW) break;
  }
  ctx.fillStyle = '#333';
  ctx.font = '8px monospace';
  ctx.textAlign = 'center'; ctx.textBaseline = 'top';
  ctx.fillText(photoData?.id || '0000000000', photoX, bcY+bcH+2);
  ctx.restore();

  // â”€â”€ Info fields (right side) â”€â”€
  if (!photoData) return;
  const fields = [
    { label: 'Name', value: photoData.name },
    { label: 'Student ID', value: photoData.id },
    { label: 'Class', value: photoData.cls },
    { label: 'D.O.B', value: photoData.dob },
    { label: 'Mobile', value: photoData.phone },
    { label: 'Address', value: photoData.address },
  ].filter(f => f.value);

  const infoX = W*0.35;
  const infoW = W - infoX - 20;
  const infoTop = HDR_H + 45;
  const infoBottom = H - 20;
  const infoH = infoBottom - infoTop;
  const lineH = Math.min(32, infoH / Math.max(fields.length,1));
  const fs = state.fontSize;

  // Name is large + bold at top
  if (photoData.name) {
    ctx.font = `bold ${fs+4}px "DM Sans", sans-serif`;
    ctx.fillStyle = state.labelColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText(photoData.name.toUpperCase(), infoX, infoTop - 30 > HDR_H ? infoTop - 30 : infoTop);
  }

  const dataFields = fields.filter(f=>f.label!=='Name');
  const startY = photoData.name ? infoTop + lineH*0.2 : infoTop;

  dataFields.forEach((f, i) => {
    const y = startY + i*lineH;
    ctx.textBaseline = 'middle';
    const midY = y + lineH*0.5;

    if (state.infoAlign === 'left') {
      // Label - value layout
      const labelW = 80;
      ctx.font = `600 ${fs-2}px "DM Sans", sans-serif`;
      ctx.fillStyle = state.labelColor;
      ctx.textAlign = 'left';
      ctx.fillText(f.label, infoX, midY);
      ctx.font = `${fs-2}px "DM Sans", sans-serif`;
      ctx.fillStyle = '#888';
      ctx.fillText('-', infoX + labelW - 8, midY);
      ctx.fillStyle = state.valueColor;
      ctx.fillText(f.value, infoX + labelW + 4, midY);
    } else {
      const str = `${f.label}: ${f.value}`;
      ctx.font = `${fs-2}px "DM Sans", sans-serif`;
      ctx.textAlign = state.infoAlign;
      const ax = state.infoAlign === 'center' ? infoX + infoW/2 : infoX + infoW;
      ctx.fillStyle = state.valueColor;
      ctx.fillText(str, ax, midY);
    }

    // thin separator line
    if (i < dataFields.length-1) {
      ctx.save();
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 0.5;
      ctx.beginPath();
      ctx.moveTo(infoX, y+lineH);
      ctx.lineTo(infoX+infoW, y+lineH);
      ctx.stroke();
      ctx.restore();
    }
  });

  // â”€â”€ Phone strip at bottom â”€â”€
  if (photoData.phone) {
    ctx.save();
    ctx.fillStyle = stripColor;
    ctx.beginPath();
    ctx.roundRect(infoX, H-28, infoW, 22, 4);
    ctx.fill();
    ctx.font = 'bold 12px "DM Sans", sans-serif';
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`ğŸ“ ${photoData.phone}`, infoX + infoW/2, H-17);
    ctx.restore();
  }
}

function drawInfoOnTemplate(ctx, student, W, H) {
  const d = getStudentData(student);
  ctx.font = `bold 22px "DM Sans", sans-serif`;
  ctx.fillStyle = state.labelColor;
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.fillText(d.name || '', 20, 20);
}

// â”€â”€â”€ RENDER PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPreview() {
  const canvas = document.getElementById('liveCanvas');
  if (!state.students.length && !state.templateImg) {
    // Draw empty preview with current settings
    updatePreviewVisibility();
    updateNavUI();
    return;
  }
  if (!state.students.length) {
    canvas.style.display = 'block';
    document.getElementById('previewEmpty').style.display = 'none';
  }
  const student = state.students[state.previewIdx] || null;
  drawCard(canvas, student);
  updateNavUI();
}

// â”€â”€â”€ GENERATE ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateAll() {
  if (!state.students.length) { alert('Please upload student data first.'); return; }
  switchTab('generated');
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = '';
  state.canvases = [];

  const prog = document.getElementById('progressWrap');
  const fill = document.getElementById('progressFill');
  const txt = document.getElementById('progressText');
  prog.style.display = 'block';
  fill.style.width = '0%';

  const canvas = document.getElementById('genCanvas');
  const total = state.students.length;

  for (let i=0; i<total; i++) {
    drawCard(canvas, state.students[i]);
    const url = canvas.toDataURL('image/png');
    state.canvases.push(url);
    const d = getStudentData(state.students[i]);
    const name = d.name || `Student ${i+1}`;

    const item = document.createElement('div');
    item.className = 'card-item';
    item.innerHTML = `
      <img src="${url}" alt="${name}">
      <div class="card-item-footer">
        <span class="card-item-name">${name}</span>
        <a class="dl-btn" href="${url}" download="id_${i+1}_${name.replace(/\s+/g,'_')}.png">â†“ PNG</a>
      </div>`;
    grid.appendChild(item);

    const pct = Math.round((i+1)/total*100);
    fill.style.width = pct+'%';
    txt.textContent = `Generating ${i+1} of ${total}...`;
    // yield to browser
    if (i%5===0) await new Promise(r=>setTimeout(r,0));
  }

  txt.textContent = `âœ“ ${total} cards generated`;
  setTimeout(()=>prog.style.display='none', 2000);

  const badge = document.getElementById('cardBadge');
  badge.textContent = total;
  badge.style.display = 'inline-block';
  document.getElementById('downloadZipBtn').disabled = false;
}

// â”€â”€â”€ DOWNLOAD ZIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function downloadZIP() {
  if (!state.canvases.length) return;
  const zip = new JSZip();
  const folder = zip.folder('id_cards');
  state.canvases.forEach((url, i) => {
    const d = getStudentData(state.students[i]);
    const name = (d.name || `student_${i+1}`).replace(/\s+/g,'_');
    const data = url.split(',')[1];
    folder.file(`${i+1}_${name}.png`, data, {base64:true});
  });
  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'id_cards.zip';
  a.click();
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updatePreviewVisibility();
updateNavUI();
debouncedRender();
</script>
</body>
</html>
